<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Employee AI Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    /* Floating icon */
    .chatbot-icon {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 28px;
    }

    /* Chatbox container */
    .chatbox-container {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 350px;
        max-width: 90%;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        overflow: hidden;
        display: none;
        flex-direction: column;
        z-index: 999;
    }

    .chat-header {
        background-color: #007bff;
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
    }

    .chat-body {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
    }

    .chat-message {
        margin-bottom: 12px;
    }

    .chat-message.user p {
        background-color: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 15px;
        display: inline-block;
        max-width: 80%;
        text-align: right;
    }

    .chat-message.bot p {
        background-color: #f1f1f1;
        padding: 8px 12px;
        border-radius: 15px;
        display: inline-block;
        max-width: 80%;
    }

    .chat-footer {
        padding: 8px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 5px;
    }

    .chat-footer input {
        flex: 1;
        padding: 8px;
        border-radius: 20px;
        border: 1px solid #ccc;
    }

    .chat-footer button {
        background-color: #007bff;
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
    }
</style>
</head>
<body>

<!-- Floating icon -->
<div class="chatbot-icon" id="chatIcon">üí¨</div>

<!-- Chatbox -->
<div class="chatbox-container" id="chatBox">
    <div class="chat-header">üíº Employee Assistant</div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-footer">
        <input type="text" id="queryInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    // Toggle chatbox
    document.getElementById("chatIcon").addEventListener("click", function () {
        const chatBox = document.getElementById("chatBox");
        chatBox.style.display = (chatBox.style.display === "flex") ? "none" : "flex";
    });

    // CSRF Token getter (Django requirement)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function sendMessage() {
        const input = document.getElementById("queryInput");
        const chatBody = document.getElementById("chatBody");
        const query = input.value.trim();
        if (!query) return;

        // Add user message
        chatBody.innerHTML += `<div class="chat-message user"><p>${query}</p></div>`;
        input.value = '';
        chatBody.scrollTop = chatBody.scrollHeight;

        // Loading...
        const loadingEl = document.createElement("div");
        loadingEl.className = "chat-message bot";
        loadingEl.innerHTML = `<p><em>Typing...</em></p>`;
        chatBody.appendChild(loadingEl);
        chatBody.scrollTop = chatBody.scrollHeight;

        try {
            const response = await fetch("/chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ query })
            });
            const data = await response.json();
            loadingEl.remove();
            chatBody.innerHTML += `<div class="chat-message bot"><p>${data.response}</p></div>`;
        } catch {
            loadingEl.remove();
            chatBody.innerHTML += `<div class="chat-message bot"><p>‚ö†Ô∏è Error: Could not connect.</p></div>`;
        }

        chatBody.scrollTop = chatBody.scrollHeight;
    }

    document.getElementById("queryInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") sendMessage();
    });
</script>

</body>
</html>
